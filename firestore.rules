rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /usernames/{username} {
      function isUsernameOfTheUser() {
        return request.auth.uid == resource.data.userId;
      }
      allow read: if isUsernameOfTheUser();
    }

    match /verified_users/{userId} {
      function userIsCheckingHimSelf() {
        return request.auth.uid == userId;
      }

      allow read: if userIsCheckingHimSelf();
    }

    match /messages/{messageId} {
      function userIsReciever() {
        return resource.data.to == request.auth.uid;
      }
      // Reading a Message
      allow read: if userIsReciever();

      function toIsNotEdited() {
        return resource.data.to == request.resource.data.to;
      }
      function contentIsNotEdited() {
        return resource.data.content == request.resource.data.content;
      }
      function createdAtIsNotEdited() {
        return resource.data.createdAt == request.resource.data.createdAt;
      }

      // Allow Reciever to edit the Love state
      allow update: if userIsReciever() &&
        toIsNotEdited() &&
        contentIsNotEdited() &&
        createdAtIsNotEdited();

      function userIsAuthor() {
        return exists(/databases/$(database)/documents/users/$(request.auth.uid)/messages/$(messageId));
      }
      // Allow Author & Reciever to delete a message
      allow delete: if userIsAuthor() || userIsReciever();
    }
  }
}